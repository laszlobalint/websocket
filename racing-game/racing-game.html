<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <meta content="utf-8" http-equiv="encoding" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game</title>
  </head>
  <body>
    <canvas id="game-canvas" width="800" height="600"></canvas>
    <canvas id="win-canvas" width="800" height="300"></canvas>
    <script>
      const trackGrid = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
      1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
      1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
      1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1,
      1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
      1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1,
      1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
      1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
      1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
      1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
      1, 0, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1,
      1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
      1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
      1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1,
      1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];

      const TRACK_W = 40;
      const TRACK_H = 40;
      const TRACK_GAP = 2;
      const TRACK_COLUMNS = 20;
      const TRACK_ROWS = 15;

      let brickGrid = [];
      let ballX = 75;
      let ballY = 75;
      let ballSpeedX = 5;
      let ballSpeedY = 7;
      let mouseX = 0;
      let mouseY = 0;
      let canvas, canvasContext, interval;

      function updateMousePosition(evt) {
        const rect = canvas.getBoundingClientRect();
        const root = document.documentElement;
        mouseX = evt.clientX - rect.left - root.scrollLeft;
        mouseY = evt.clientY - rect.top - root.scrollTop;
      }

      window.onload = function () {
        canvas = document.getElementById('game-canvas');
        canvasContext = canvas.getContext('2d');
        let framesPerSecond = 30;
        interval = setInterval(updateAll, 1000 / framesPerSecond);
        canvas.addEventListener('mousemove', updateMousePosition);
        resetBall();
      };

      function resetBall() {
        for (let eachRow = 0; eachRow < TRACK_ROWS; eachRow++) {
          for (let eachCol = 0; eachCol < TRACK_COLUMNS; eachCol++) {
            let arrayIndex = rowColToArrayIndex(eachCol, eachRow);
            if (trackGrid[arrayIndex] === 2) {
              trackGrid[arrayIndex] = 0;
              ballX = eachCol * TRACK_W + TRACK_W / 2;
              ballY = eachRow * TRACK_H + TRACK_H / 2;
            }
          }
        }
      }

      function ballMoveHandler() {
        ballX += ballSpeedX;
        ballY += ballSpeedY;
        if (ballX > canvas.width || (ballX < 0 && ballSpeedX < 0.0)) ballSpeedX *= -1;
        if (ballY > canvas.height || (ballY < 0 && ballSpeedX > 0.0)) ballSpeedY *= -1;
        if (ballY > canvas.height) {
          resetBall();
          ballSpeedY *= -1;
        }
      }

      function isTrackAtColRow(col, row) {
        if (col >= 0 && col < TRACK_COLUMNS && row >= 0 && row < TRACK_ROWS) {
          const trackIndexUnderCoord = rowColToArrayIndex(col, row);
          return trackGrid[trackIndexUnderCoord] === 1;
        } else {
          return false;
        }
      }

      function ballTrackHandler() {
        let ballTrackCol = Math.floor(ballX / TRACK_W);
        let ballTrackRow = Math.floor(ballY / TRACK_H);
        let trackIndexUnderBall = rowColToArrayIndex(ballTrackCol, ballTrackRow);

        if (ballTrackCol >= 0 && ballTrackCol < TRACK_COLUMNS && ballTrackRow >= 0 && ballTrackRow < TRACK_ROWS) {
          if (isTrackAtColRow(ballTrackCol, ballTrackRow)) {
            let prevBallX = ballX - ballSpeedX;
            let prevBallY = ballY - ballSpeedY;
            let prevTrackCol = Math.floor(prevBallX / TRACK_W);
            let prevTrackRow = Math.floor(prevBallY / TRACK_H);
            let bothTestsFailed = true;

            if (prevTrackCol != ballTrackCol && !isTrackAtColRow(prevTrackCol, ballTrackRow)) {
              ballSpeedX *= -1;
              bothTestsFailed = false;
            }
            if (prevTrackRow !== ballTrackRow && !isTrackAtColRow(ballTrackCol, prevTrackRow)) {
              ballSpeedY *= -1;
              bothTestsFailed = false;
            }
            if (bothTestsFailed) {
              ballSpeedX *= -1;
              ballSpeedY *= -1;
            }
          }
        }
      }

      function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight);
      }

      function colorCircle(centerX, centerY, radius, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.beginPath();
        canvasContext.arc(centerX, centerY, radius, 0, Math.PI * 2, true);
        canvasContext.fill();
      }

      function colorText(showWords, textX, textY, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.fillText(showWords, textX, textY);
      }

      function rowColToArrayIndex(col, row) {
        return col + TRACK_COLUMNS * row;
      }

      function drawTracks() {
        for (let eachRow = 0; eachRow < TRACK_ROWS; eachRow++) {
          for (let eachCol = 0; eachCol < TRACK_COLUMNS; eachCol++) {
            let arrayIndex = rowColToArrayIndex(eachCol, eachRow);
            if (trackGrid[arrayIndex]) colorRect(TRACK_W * eachCol, TRACK_H * eachRow, TRACK_W - TRACK_GAP, TRACK_H - TRACK_GAP, 'blue');
          }
        }
      }

      function winnerNotification() {
        clearTimeout(interval);
        let winCanvas = document.getElementById('win-canvas');
        ctx = winCanvas.getContext('2d');
        ctx.fillStyle = 'red';
        ctx.font = '36px san-serif';
        const textString = 'You have won the game! Congratulations!';
        const textWidth = ctx.measureText(textString).width;
        ctx.fillText(textString, winCanvas.width / 2 - textWidth / 2, 100);
      }

      function updateAll() {
        moveAll();
        drawAll();
      }

      function moveAll() {
        ballMoveHandler();
        ballTrackHandler();
      }

      function drawAll() {
        colorRect(0, 0, canvas.width, canvas.height, 'black');
        colorCircle(ballX, ballY, 10, 'white');
        drawTracks();
      }
    </script>
  </body>
</html>
